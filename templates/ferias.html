{% extends "base.html" %}

{% block title %}Férias - Gerenciador de Férias{% endblock %}

{% block content %}
<h2 class="mb-4"><i class="bi bi-calendar-check"></i> Gerenciar Férias</h2>

{% if not employees %}
    <div class="alert alert-warning">
        <i class="bi bi-exclamation-triangle"></i>
        Cadastre funcionários primeiro na aba <a href="{{ url_for('funcionarios') }}">Funcionários</a>
    </div>
{% else %}
    <div class="row">
        <!-- Formulário de Adicionar -->
        <div class="col-md-4 mb-4">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">Adicionar Período de Férias</h5>
                    <form method="POST">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="mb-3">
                            <label for="employee_id" class="form-label">Funcionário</label>
                            <select class="form-select" id="employee_id" name="employee_id" required>
                                <option value="" selected disabled>--- Selecione um funcionário ---</option>
                                {% for emp in employees %}
                                <option value="{{ emp.id }}">{{ emp.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="start_date" class="form-label">Data Inicial</label>
                            <input type="date" class="form-control" id="start_date"
                                   name="start_date" required>
                        </div>

                        <div class="mb-3">
                            <label for="days" class="form-label">Quantidade de Dias</label>
                            <input type="number" class="form-control" id="days"
                                   name="days" min="1" max="365" required>
                        </div>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-plus-circle"></i> Adicionar Férias
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Lista de Férias -->
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">Períodos de Férias Cadastrados</h5>

                    {% if vacations %}
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>Início</th>
                                        <th>Fim</th>
                                        <th>Nº de Dias</th>
                                        <th class="text-center">Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for vac in vacations %}
                                    <tr>
                                        <td><strong>{{ vac.name }}</strong></td>
                                        <td>{{ vac.start_date }}</td>
                                        <td>{{ vac.end_date }}</td>
                                        <td>{{ vac.num_days }}</td>
                                        <td class="text-center">
                                            <button type="button" class="btn btn-sm btn-warning me-1"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#editModal"
                                                    data-vacation-id="{{ vac.id }}"
                                                    data-employee-id="{{ vac.employee_id }}"
                                                    data-employee-name="{{ vac.name }}"
                                                    data-start-date="{{ vac.start_date_obj.strftime('%Y-%m-%d') }}"
                                                    data-end-date="{{ vac.end_date_obj.strftime('%Y-%m-%d') }}">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <form method="POST" action="{{ url_for('delete_ferias', vacation_id=vac.id) }}"
                                                  onsubmit="return confirm('Tem certeza que deseja remover este período de férias?');"
                                                  style="display: inline;">
                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                <button type="submit" class="btn btn-sm btn-danger">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="alert alert-info mb-0">
                            <i class="bi bi-info-circle"></i> Nenhum período de férias cadastrado
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Edição -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editModalLabel">Editar Período de Férias</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <form id="editForm" method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="edit_employee_id" class="form-label">Funcionário</label>
                            <select class="form-select" id="edit_employee_id" name="employee_id" required>
                                {% for emp in employees %}
                                <option value="{{ emp.id }}">{{ emp.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="edit_start_date" class="form-label">Data Inicial</label>
                            <input type="date" class="form-control" id="edit_start_date"
                                   name="start_date" required>
                        </div>

                        <div class="mb-3">
                            <label for="edit_end_date" class="form-label">Data Final</label>
                            <input type="date" class="form-control" id="edit_end_date"
                                   name="end_date" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle"></i> Salvar Alterações
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Preencher o modal de edição com os dados da férias selecionada
        document.addEventListener('DOMContentLoaded', function() {
            const editModal = document.getElementById('editModal');

            editModal.addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget;

                // Extrair dados dos atributos data-*
                const vacationId = button.getAttribute('data-vacation-id');
                const employeeId = button.getAttribute('data-employee-id');
                const startDate = button.getAttribute('data-start-date');
                const endDate = button.getAttribute('data-end-date');

                // Atualizar o action do formulário
                const form = document.getElementById('editForm');
                form.action = `/ferias/update/${vacationId}`;

                // Preencher os campos do formulário
                document.getElementById('edit_employee_id').value = employeeId;
                document.getElementById('edit_start_date').value = startDate;
                document.getElementById('edit_end_date').value = endDate;
            });
        });
    </script>
{% endif %}
{% endblock %}
